#! /bin/bash
#引数としてコミットの ハッシュ HEAD HEAD^ 等のmergeコミットを一つ入力
#automergeが起きたファイルを全て表示

#入力されたコミットの親の数を確認
PearentNum=$(echo $(git log $1 -1 --pretty=format:"%P" | wc -w))

#中間ファイル名の設定
TEMP_MERGED="/tmp/merged.$$"
TEMP_MERGED_SORTED="/tmp/merged_sorted.$$"
TEMP_AUTOMERGED="/tmp/automerged.$$"

#merge commitかチェック
if [ $PearentNum -gt 1 ] ; then
	#親が2以上(merge commitの場合)
	#入力されたコミットとその親との差分が存在するファイル名からmergeが行われたファイルを列挙

	#親の数だけループ
	i=1
	for Pearent in $(git log $1 -1 --pretty=format:"%P")
	do
		#一応親のハッシュを出力しておく
		echo "Pearent $i : $Pearent"
		git diff --name-only $1 $Pearent >> TEMP_MERGED
		i=$(expr $i + 1)
	done

	#mergeされたファイルのソート
	sort TEMP_MERGED > TEMP_MERGED_SORTED
	
	#重複しているファイルの抽出
	uniq TEMP_MERGED_SORTED --repeated > TEMP_AUTOMERGED
	
	#重複しているファイルがあれば出力
	if [ -s TEMP_AUTOMERGED ] ; then
		echo "automerged file name"
		cat TEMP_AUTOMERGED
	else
		echo "no automerge"
	fi

	#中間ファイルの削除
	rm TEMP_MERGED
	rm TEMP_MERGED_SORTED
	rm TEMP_AUTOMERGED

else
	#親が2以上いないなら処理を終了
	echo "$(git log $1 -1 --pretty=format:"%P") is not MergeCommit"
fi

